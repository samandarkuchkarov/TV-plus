function VideoCatalogScreen(){var that=this;var genresMenu=new BaseMenu({menuId:"genres-menu",menuTag:"ul",itemIdPrefix:"genre",itemTag:"li",useFastRefresh:true,hideItemIfEmptyName:true,relatedItemIdPrefix:"videocatalog-selector",getItemNameFunc:function(sourceItemIndex,displayItemIndex){var genre=null;var a=-1,b=-1,d=-1,c=0;if(searchString){a=0;c++}if(App.clientSettings.vod_show_news!==false){b=a+1;c++}if(isViewedCategory){d=b+1;c++}if(sourceItemIndex===a){genre=getSpecialCategoryForSearch()}else{if(sourceItemIndex===b){genre=getSpecialCategoryForNews()}else{if(sourceItemIndex===d){genre=getSpecialCategoryForViewed()}else{filterByGenres?genre=App.data.getGenre(sourceItemIndex-c):genre=App.data.getGenreCategory(sourceItemIndex-c)}}}if(genre){return genre.name}else{return""}},onItemClick:function(index){if(focusedMenu!=="genres"){focusedMenu="genres";videosMenu.unsetMenuFocus();genresMenu.setMenuFocus()}var sourceItems=genresMenu.getCurrentPage()*genresMenu.getNumberOfDisplayItems()+index;genresMenu.setSelectedItem(index,sourceItems);currentPage=1;that.refreshVideos(true)},onItemMouseOver:function(index){if(focusedMenu!=="genres"){focusedMenu="genres";videosMenu.unsetMenuFocus();genresMenu.setMenuFocus();if(navigationMode==="horizontal"){Helper.hideById("videocatalog-footer-left");Helper.showById("videocatalog-footer-menu")}}var sourceItems=genresMenu.getCurrentPage()*genresMenu.getNumberOfDisplayItems()+index;genresMenu.setSelectedItem(index,sourceItems);currentPage=1;that.refreshVideos(true)}});var selectorMenu=new BaseMenu({displayItemsNumber:5,sourceItemsNumber:5,menuId:"videocatalog-selector",menuTag:"div",itemIdPrefix:"videocatalog-selector",itemTag:"div",useFastRefresh:false});var currentPage=1;var videosMenu=new BaseMenu({menuId:"videos-menu",menuTag:"ul",itemIdPrefix:"video",itemTag:"li",useFastRefresh:true,hideItemIfEmptyName:true,loopMenuFromBeginToEnd:false,loopMenuFromEndToBegin:false,getItemNameFunc:function(realItemIndex,itemIndex,node){var video=App.data.getVideo(realItemIndex);if(video){if(!node){return true}else{var name=Helper.cropStringIn2Line(video.name,12,"..");var iconElement=document.createElement("img");iconElement.setAttribute("src",Helper.getResourceUrl(video.thumbnail_small));var nameElement=document.createElement("p");nameElement.innerHTML=name;node.appendChild(iconElement);node.appendChild(nameElement);var videoProvider=App.data.getVideoProviderTitle(video.provider);if(videoProvider){var videoProvidedBy=document.createElement("div");Helper.addClassForObject(videoProvidedBy,"list-video-provided-by");var videoProviderLogo=document.createElement("div");Helper.addClassForObject(videoProviderLogo,"list-video-provider-logo");Helper.addClassForObject(videoProviderLogo,"provider-logo-"+videoProvider.toLowerCase());videoProvidedBy.appendChild(videoProviderLogo);node.appendChild(videoProvidedBy)}}}else{return""}},onItemClick:function(index){that.key_enter()},onItemMouseOver:function(index){if(focusedMenu==="genres"){that.key_right()}var sourceItemIndex=videosMenu.getCurrentPage()*videosMenu.getNumberOfDisplayItems()+index;videosMenu.setSelectedItem(index,sourceItemIndex);if(sourceItemIndex===App.data.getNumberOfVideos()-1){App.videoCatalogScreen.refreshVideos(false,++currentPage)}},onSourceItemsEndReached:function(){App.videoCatalogScreen.refreshVideos(false,++currentPage)}});var focusedMenu="";var refreshTimeout=null;var initialGenreId=null;var navigationMode="normal";var searchString="",orderBy="";var filterByGenres=true;var isViewedCategory=false;var timeInterval=null;function getSpecialCategoryForSearch(){return{id:"search",name:App.lang.get("video-search-category")}}function getSpecialCategoryForNews(){return{id:"new",name:App.lang.get("new-videos")}}function getSpecialCategoryForViewed(){return{id:"viewed",name:App.lang.get("viewed-videos")}}this.setInitialSectionId=function(sectionId){initialGenreId=parseInt(sectionId)};this.getSelectedGenre=function(){var a=-1,b=-1,d=-1,c=0;if(searchString){a=0;c++}if(App.clientSettings.vod_show_news!==false){b=a+1;c++}if(isViewedCategory){d=b+1;c++}var genre=null;if(genresMenu.getSelectedSourceItem()===a){genre=getSpecialCategoryForSearch()}else{if(genresMenu.getSelectedSourceItem()===b){genre=getSpecialCategoryForNews()}else{if(genresMenu.getSelectedSourceItem()===d){genre=getSpecialCategoryForViewed()}else{filterByGenres?genre=App.data.getGenre(genresMenu.getSelectedSourceItem()-c):genre=App.data.getGenreCategory(genresMenu.getSelectedSourceItem()-c)}}}return genre};this.reset=function(){_VideoCatalogScreen.setInited(false)};this.refreshDisplayTime=function(){var now=Helper.withTimezone(App.data.getUtcTime());var d=new Date(now*1000);var date=("0"+d.getDate()).substr(-2,2)+" "+App.lang.get("month-"+d.getMonth())+" "+d.getFullYear();var timeStr=("0"+d.getHours()).substr(-2,2)+":"+("0"+d.getMinutes()).substr(-2,2);Helper.setHtml("videocatalog-clock",date+" "+timeStr)};this.show=function(){App.playerScreen.hideTvInfoBar();App.playerScreen.hideVideoInfoBar();_VideoCatalogScreen.show();if(!timeInterval){this.refreshDisplayTime();timeInterval=setInterval(that.refreshDisplayTime,15000)}if(App.showHelpButtonPanelFlag&&App.device.getAPIVersion()>=109&&!App.settings.getReferenceShownFlag()){App.popupMessageScreen.setMessageText(App.lang.get("key-panel-reference"));App.popupMessageScreen.setOnHideCallback(function(){App.settings.setReferenceShownFlag(true);App.settings.saveSettings();App.popupMessageScreen.setOnHideCallback(null)});App.display.showPopupScreen("popup-message")}};this.init=function(){_VideoCatalogScreen.init();focusedMenu="genres";filterByGenres=App.clientSettings.filter_videos_by_genres;genresMenu.setMenuFocus();var that=this;var options={};if(!filterByGenres){options.categories=1}App.data.requestGenreList(options,function(error){if(error==0){Helper.showById("videocatalog-clock");App.data.requestVideoList({limit:1,viewed_only:1},function(){if(App.data.getNumberOfVideos()>0){isViewedCategory=true}that.refreshGenres(true)})}});navigationMode=App.clientSettings.navigation_mode;if(navigationMode!=="horizontal"){Helper.hideById("video-footer-videocatalog");Helper.showById("video-footer-left")}};this.refreshGenres=function(requestVideos){var genresCount=0;genresCount=filterByGenres?App.data.getNumberOfGenres():App.data.getNumberOfGenresCategory();var c=0;if(searchString){c++}if(App.clientSettings.vod_show_news){c++}if(isViewedCategory){c++}var n=9;if(genresCount+c<n){n=genresCount+c}if(n<=c){Helper.showById("videocatalog-empty-list")}else{Helper.hideById("videocatalog-empty-list");var s="";for(var i=0;i<n;i++){s+='<div id="videocatalog-selector'+i+'"></div>'}Helper.setHtml("videocatalog-selector",s);genresMenu.clear();genresMenu.setNumberOfDisplayItems(n);genresMenu.setNumberOfSourceItems(genresCount+c);genresMenu.setSelectedItem(0,0);genresMenu.redrawMenuItems();if(requestVideos){if(initialGenreId!=null){var genre=null;if(filterByGenres){for(i=0;i<genresCount;i++){genre=App.data.getGenre(genresMenu.getSelectedSourceItem());if(genre.id==initialGenreId){break}genresMenu.setNextItem()}}else{for(i=0;i<genresCount;i++){genre=App.data.getGenreCategory(genresMenu.getSelectedSourceItem());if(genre.id==initialGenreId){break}genresMenu.setNextItem()}}initialGenreId=null}this.refreshVideos()}}};this.refreshVideos=function(timeout,page){if(!page){page=1}var selectedGenreItemIndex=genresMenu.getSelectedDisplayItem();var genre=this.getSelectedGenre();if(!genre||selectedGenreItemIndex===-1){return}if(timeout){if(refreshTimeout){clearTimeout(refreshTimeout)}var ths=this;refreshTimeout=setTimeout(function(){ths.refreshVideos()},350);return}var c=0;if(searchString){c++}if(App.clientSettings.vod_show_news){c++}if(isViewedCategory){c++}var options={};if(genresMenu.getSelectedSourceItem()>=c){options.gid=genre.id}if(genre.id==="new"){if(App.clientSettings.show_vod_premiere_in_news){options.premiere=1}else{options["new"]=1}}if(genre.id==="search"&&searchString){options.search=searchString}if(genre.id==="viewed"){options.viewed_only=1}options.video_type="non_package";if(!orderBy){orderBy=App.clientSettings.default_vod_sort_order}options.order=orderBy;switch(orderBy){default:case"-created_at":Helper.setHtml("videocatalog-sort",App.lang.get("sort-order-news-first"));break;case"-premiere_date":Helper.setHtml("videocatalog-sort",App.lang.get("sort-order-by-premiere-date"));break;case"-kinopoisk_rating":Helper.setHtml("videocatalog-sort",App.lang.get("sort-order-by-kinopoisk-rating"));break;case"-imdb_rating":Helper.setHtml("videocatalog-sort",App.lang.get("sort-order-by-imdb-rating"));break;case"name":Helper.setHtml("videocatalog-sort",App.lang.get("sort-order-by-name"));break;case"-year":Helper.setHtml("videocatalog-sort",App.lang.get("sort-order-by-year"));break}options.limit=50;options.page=page;Helper.addClass("videocatalog-screen-container","loader");App.data.requestVideoList(options,function(error){Helper.removeClass("videocatalog-screen-container","loader");if(error==0){if(genresMenu.getSelectedDisplayItem()!==selectedGenreItemIndex){return}var nrows=2;var ncolumns=5;var n=ncolumns*nrows;var nv=App.data.getNumberOfVideos();if(nv<n){if(nv<=ncolumns){ncolumns=nv;nrows=1;n=ncolumns}else{n=nv}}if(n===0){videosMenu.clear();if(genre.id==="search"){Helper.setHtml("videocatalog-no-videos-in-category",App.lang.get("videos-not-found"));focusedMenu="genres";videosMenu.unsetMenuFocus();genresMenu.setMenuFocus()}else{Helper.setHtml("videocatalog-no-videos-in-category",App.lang.get("label-empty-video-category"))}Helper.showById("videocatalog-no-videos-in-category")}else{Helper.hideById("videocatalog-no-videos-in-category");if(page<=1){videosMenu.clear()}videosMenu.setNumberOfDisplayItems(n);videosMenu.setNumberOfColumns(ncolumns);videosMenu.setNumberOfRows(nrows);videosMenu.setNumberOfSourceItems(nv);if(page<=1){videosMenu.setSelectedItem(0,0)}videosMenu.redrawMenuItems()}}})};this.switchPreviousVideo=function(){videosMenu.setPreviousItem();App.videoScreen.setVideo(App.data.getVideo(videosMenu.getSelectedSourceItem()))};this.switchNextVideo=function(){videosMenu.setNextItem();App.videoScreen.setVideo(App.data.getVideo(videosMenu.getSelectedSourceItem()))};this.key_green=function(){var that=this;App.popupMenuScreen.addListMenuItem(App.lang.get("search-by-name"),function(){App.popupMenuScreen.hide();App.keyboardScreen.setMaxInputLength();App.keyboardScreen.setCallback(function(str){if(str||searchString){currentPage=1}searchString=str;that.refreshGenres();that.refreshVideos()});App.keyboardScreen.setInitialString(searchString);App.display.showPopupScreen("keyboard")});if(searchString){App.popupMenuScreen.addListMenuItem(App.lang.get("reset-search"),function(){App.popupMenuScreen.hide();currentPage=1;searchString="";that.refreshGenres();that.refreshVideos()})}App.popupMenuScreen.addListMenuItem(App.lang.get("sort-by-kinopoisk-rating"),function(){orderBy="-kinopoisk_rating";that.refreshVideos();App.popupMenuScreen.hide()});App.popupMenuScreen.addListMenuItem(App.lang.get("sort-by-imdb-rating"),function(){orderBy="-imdb_rating";that.refreshVideos();App.popupMenuScreen.hide()});App.popupMenuScreen.addListMenuItem(App.lang.get("sort-by-premiere-date"),function(){orderBy="-premiere_date";that.refreshVideos();App.popupMenuScreen.hide()});App.popupMenuScreen.addListMenuItem(App.lang.get("show-news-first"),function(){orderBy="-created_at";that.refreshVideos();App.popupMenuScreen.hide()});App.popupMenuScreen.addListMenuItem(App.lang.get("sort-by-name"),function(){orderBy="name";that.refreshVideos();App.popupMenuScreen.hide()});App.popupMenuScreen.addListMenuItem(App.lang.get("sort-by-year"),function(){orderBy="-year";that.refreshVideos();App.popupMenuScreen.hide()});App.display.showPopupScreen("popup-menu")};this.key_back=function(){App.display.showScreen("mainmenu")};this.key_down=function(){if(focusedMenu==="genres"){genresMenu.setNextItem();currentPage=1;this.refreshVideos(true)}else{videosMenu.setDownItem()}};this.key_up=function(){if(focusedMenu==="genres"){genresMenu.setPreviousItem();currentPage=1;this.refreshVideos(true)}else{videosMenu.setUpItem()}};this.key_right=function(){if(focusedMenu==="genres"){if(App.data.getNumberOfVideos()>0){focusedMenu="videos";genresMenu.unsetMenuFocus();videosMenu.setMenuFocus();if(navigationMode==="horizontal"){Helper.showById("videocatalog-footer-left");Helper.hideById("videocatalog-footer-menu")}}}else{videosMenu.setNextItem()}};this.key_left=function(){if(focusedMenu==="genres"){if(navigationMode==="horizontal"){this.key_menu()}}else{if(videosMenu.getSelectedColumn()===0){focusedMenu="genres";videosMenu.unsetMenuFocus();genresMenu.setMenuFocus();if(navigationMode==="horizontal"){Helper.hideById("videocatalog-footer-left");Helper.showById("videocatalog-footer-menu")}}else{videosMenu.setPreviousItem()}}};this.key_enter=function(){if(focusedMenu==="genres"){var genre=this.getSelectedGenre();if(genre&&genre.id==="search"&&App.data.getNumberOfVideos()<=0){this.key_green()}else{this.key_right()}}else{if(videosMenu.getNumberOfSourceItems()>0){App.videoScreen.setVideo(App.data.getVideo(videosMenu.getSelectedSourceItem()));App.display.showScreen("video")}}};this.key_menu=function(){App.display.showScreen("mainmenu")};this.key_exit=function(){if(App.player.isActive()){App.display.showScreen("player")}else{App.display.showScreen("mainmenu")}};this.key_backspace=function(){this.key_exit()};this.key_power=function(){App.switchStandBy()};this.wheel=function(delta){if(delta>0){if(focusedMenu==="genres"){this.key_down()}else{this.key_right()}}else{if(focusedMenu==="genres"){this.key_up()}else{this.key_left()}}};this.key_long_enter=function(){if(App.showHelpButtonPanelFlag){var keys=[{action:"menu",label:"label-menu"},{action:"green",label:"label-search-and-sort"},{action:"back",label:"label-back"}];App.popupKeyPanelScreen.setKeysForPanel(keys);App.popupKeyPanelScreen.setParentScreen("videocatalog");App.display.showPopupScreen("popup-key-panel")}else{this.key_enter()}}}_VideoCatalogScreen=new BaseScreen();VideoCatalogScreen.prototype=_VideoCatalogScreen;