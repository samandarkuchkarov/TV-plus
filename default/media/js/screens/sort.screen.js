function SortScreen(){var selfScreenContainerObject=null;var remoteButtonOkObject=null;var sortChannelsMenu=new BaseMenu({menuId:"sort-channels-menu",menuTag:"ul",itemIdPrefix:"sort-channel",itemTag:"li",useFastRefresh:true,hideItemIfEmptyName:true,getItemNameFunc:function(sourceItemIndex,displayItemIndex,node){if(sourceItemIndex<sortedArray.length){if(!node){return true}else{var channel=App.data.getChannelById(sortedArray[sourceItemIndex]["id"],true);if(channel){var number=("00"+(sourceItemIndex+1)).substr(-3,3);node.innerHTML=number;var channelIcon=document.createElement("img");channelIcon.setAttribute("src",Helper.getResourceUrl(channel.icon));node.appendChild(channelIcon);if(!channel.has_subscription){var lockedChannelIconElement=document.createElement("img");lockedChannelIconElement.setAttribute("src",Helper.getResourceUrl("media/img/main/locked-channel-icon.png"));lockedChannelIconElement.setAttribute("class","locked");node.appendChild(lockedChannelIconElement)}var channelName=document.createTextNode(channel.name);node.appendChild(channelName)}}}else{return false}},onItemSelect:function(sourceItemIndex,displayItemIndex){},onItemMouseOver:function(index){that.setSelectedItemAllMenus(index)}});var moveDownMenu=new BaseMenu({menuId:"move-down-menu",menuTag:"ul",itemIdPrefix:"move-down",itemTag:"li",useFastRefresh:true,hideItemIfEmptyName:true,useMovableSelectionEffect:true,getItemNameFunc:function(sourceItemIndex,displayItemIndex,node){if(sourceItemIndex<sortedArray.length){if(!node){return true}else{var div=document.createElement("div");node.appendChild(div)}}else{return false}},onItemClick:function(index){changed=true;that.moveDown();that.setNextItemAllMenus();that.redrawAllMenus()},onItemMouseOver:function(index){that.onItemMouseOver(index,moveDownMenu)}});var moveUpMenu=new BaseMenu({menuId:"move-up-menu",menuTag:"ul",itemIdPrefix:"move-up",itemTag:"li",useFastRefresh:true,hideItemIfEmptyName:true,useMovableSelectionEffect:true,getItemNameFunc:function(sourceItemIndex,displayItemIndex,node){if(sourceItemIndex<sortedArray.length){if(!node){return true}else{var div=document.createElement("div");node.appendChild(div)}}else{return false}},onItemClick:function(index){changed=true;that.moveUp();that.setPreviousItemAllMenus();that.redrawAllMenus()},onItemMouseOver:function(index){that.onItemMouseOver(index,moveUpMenu)}});var hideMenu=new BaseMenu({menuId:"hide-menu",menuTag:"ul",itemIdPrefix:"hide",itemTag:"li",useFastRefresh:true,hideItemIfEmptyName:true,useMovableSelectionEffect:true,getItemNameFunc:function(sourceItemIndex,displayItemIndex,node){if(sourceItemIndex<sortedArray.length){if(!node){return true}else{var div=document.createElement("div");if(sortedArray[sourceItemIndex]["is_hidden"]){div.setAttribute("class","enabled")}node.appendChild(div)}}else{return false}},onItemClick:function(index){changed=true;var item=sortedArray[sortChannelsMenu.getSelectedSourceItem()];that.callWithParentCode(item.is_parent_control,function(){item.is_hidden=!item.is_hidden;that.redrawAllMenus()})},onItemMouseOver:function(index){that.onItemMouseOver(index,hideMenu)}});var parentMenu=new BaseMenu({menuId:"parent-menu",menuTag:"ul",itemIdPrefix:"parent",itemTag:"li",useFastRefresh:true,hideItemIfEmptyName:true,useMovableSelectionEffect:true,getItemNameFunc:function(sourceItemIndex,displayItemIndex,node){if(sourceItemIndex<sortedArray.length){if(!node){return true}else{var div=document.createElement("div");if(sortedArray[sourceItemIndex]["is_parent_control"]){div.setAttribute("class","enabled")}node.appendChild(div)}}else{return false}},onItemClick:function(index){changed=true;that.callWithParentCode(true,function(){var item=sortedArray[sortChannelsMenu.getSelectedSourceItem()];item.is_parent_control=!item.is_parent_control;that.redrawAllMenus()})},onItemMouseOver:function(index){that.onItemMouseOver(index,parentMenu)}});var sortedArray=[];var focusedMenu=moveDownMenu;var that=this;var changed=false;this.initSortedArray=function(channelParams){var n=App.data.getNumberOfChannels(true);if(n>0){for(var i=0;i<n;i++){var channel=App.data.getChannel(i,true);var channelParam=false;if(channelParams){try{channelParam=channelParams[channel.id]}catch(e){}}sortedArray[i]={id:channel.id,is_favorited:false,is_hidden:channelParam?channelParam.is_hidden:channel.is_hidden,is_parent_control:channelParam?channelParam.is_parent_control:channel.is_parent_control}}}};this.onItemMouseOver=function(index,menu){if(focusedMenu){focusedMenu.unsetMenuFocus()}that.setSelectedItemAllMenus(index);focusedMenu=menu;if(focusedMenu){focusedMenu.setMenuFocus()}that.setHeadersAndLabels()};this.moveDown=function(){var itemIndex=sortChannelsMenu.getSelectedSourceItem();if(sortedArray.length<=itemIndex){return}var nextItemIndex;if(sortedArray.length>itemIndex+1){nextItemIndex=itemIndex+1;var nextItem=sortedArray[nextItemIndex];sortedArray[nextItemIndex]=sortedArray[itemIndex];sortedArray[itemIndex]=nextItem}else{sortedArray.unshift(sortedArray[itemIndex]);sortedArray.pop()}};this.moveUp=function(){var itemIndex=sortChannelsMenu.getSelectedSourceItem();if(sortedArray.length<=itemIndex){return}var nextItemIndex;if(itemIndex-1>=0){nextItemIndex=itemIndex-1;var nextItem=sortedArray[nextItemIndex];sortedArray[nextItemIndex]=sortedArray[itemIndex];sortedArray[itemIndex]=nextItem}else{sortedArray.push(sortedArray[itemIndex]);sortedArray.shift()}};this.refreshMenuSize=function(menu,numberOfDisplayItems,numberOfSourceItems){if(menu){menu.clear();menu.setNumberOfRows(numberOfDisplayItems);menu.setNumberOfDisplayItems(numberOfDisplayItems);menu.setNumberOfSourceItems(numberOfSourceItems);menu.setSelectedItem(0,0);menu.redrawMenuItems()}};this.refreshAllMenus=function(numberOfDisplayItems,numberOfSourceItems){this.refreshMenuSize(sortChannelsMenu,numberOfDisplayItems,numberOfSourceItems);this.refreshMenuSize(moveDownMenu,numberOfDisplayItems,numberOfSourceItems);this.refreshMenuSize(moveUpMenu,numberOfDisplayItems,numberOfSourceItems);this.refreshMenuSize(hideMenu,numberOfDisplayItems,numberOfSourceItems);this.refreshMenuSize(parentMenu,numberOfDisplayItems,numberOfSourceItems)};this.redrawAllMenus=function(){sortChannelsMenu.redrawMenuItems();moveDownMenu.redrawMenuItems();moveUpMenu.redrawMenuItems();hideMenu.redrawMenuItems();parentMenu.redrawMenuItems()};this.setNextItemAllMenus=function(){sortChannelsMenu.setNextItem();moveDownMenu.setNextItem();moveUpMenu.setNextItem();hideMenu.setNextItem();parentMenu.setNextItem()};this.setPreviousItemAllMenus=function(){sortChannelsMenu.setPreviousItem();moveDownMenu.setPreviousItem();moveUpMenu.setPreviousItem();hideMenu.setPreviousItem();parentMenu.setPreviousItem()};this.setFirstItemAllMenus=function(){sortChannelsMenu.setSelectedItem(0,0);moveDownMenu.setSelectedItem(0,0);moveUpMenu.setSelectedItem(0,0);hideMenu.setSelectedItem(0,0);parentMenu.setSelectedItem(0,0);moveUpMenu.unsetMenuFocus();hideMenu.unsetMenuFocus();parentMenu.unsetMenuFocus();moveDownMenu.setMenuFocus();focusedMenu=moveDownMenu;this.redrawAllMenus()};this.setSelectedItemAllMenus=function(index){sortChannelsMenu.setSelectedItem(index,index);moveDownMenu.setSelectedItem(index,index);moveUpMenu.setSelectedItem(index,index);hideMenu.setSelectedItem(index,index);parentMenu.setSelectedItem(index,index)};this.callWithParentCode=function(condition,callback,onHideCallback){if(!condition){if(callback instanceof Function){callback()}}else{App.popupParentCodeScreen.setCallback(function(success){if(success){if(callback instanceof Function){callback()}}else{App.popupMessageScreen.setMessageText(App.lang.get("invalid-parent-code"));App.display.showPopupScreen("popup-message")}});App.popupParentCodeScreen.setOnHideCallback(onHideCallback);App.display.showPopupScreen("popup-parent-code-screen")}};this.setHeadersAndLabels=function(){if(!remoteButtonOkObject){remoteButtonOkObject=Helper.byId("sort-screen-remote-button-ok")}var s="";switch(focusedMenu){default:s="label-ok";break;case moveDownMenu:case moveUpMenu:s="label-move";break;case hideMenu:s="label-hide-show";break;case parentMenu:s="label-set-unset-pin";break}Helper.setHtmlForObject(remoteButtonOkObject,App.lang.get(s));Helper.addClassForObject(remoteButtonOkObject,s)};this.show=function(){if(!selfScreenContainerObject){selfScreenContainerObject=Helper.byId("sort-screen-container")}this.setHeadersAndLabels();_SortScreen.show();this.setFirstItemAllMenus()};this.init=function(){_SortScreen.init();var n=10;if(App.data.getNumberOfChannels(true)>0&&App.data.getNumberOfChannels(true)<n){n=App.data.getNumberOfChannels(true)}this.refreshAllMenus(n,App.data.getNumberOfChannels(true));n=App.data.getNumberOfChannels(true);if(n>0){if(n>sortChannelsMenu.getNumberOfRows()){n=sortChannelsMenu.getNumberOfRows()}this.initSortedArray();this.refreshAllMenus(n,App.data.getNumberOfChannels(true))}else{Helper.addClassForObject(selfScreenContainerObject,"loader");App.data.requestChannelList({icon_width:40,icon_height:40},function(error,interval){Helper.removeClassForObject(selfScreenContainerObject,"loader");if(error==0){var n=App.data.getNumberOfChannels(true);if(n>sortChannelsMenu.getNumberOfRows()){n=sortChannelsMenu.getNumberOfRows()}that.initSortedArray();that.refreshAllMenus(n,App.data.getNumberOfChannels(true))}},false)}};this.key_enter=function(){changed=true;switch(focusedMenu){case moveDownMenu:this.moveDown();this.setNextItemAllMenus();this.redrawAllMenus();break;case moveUpMenu:this.moveUp();this.setPreviousItemAllMenus();this.redrawAllMenus();break;case hideMenu:var item=sortedArray[sortChannelsMenu.getSelectedSourceItem()];this.callWithParentCode(item.is_parent_control,function(){item.is_hidden=!item.is_hidden;that.redrawAllMenus()});break;case parentMenu:this.callWithParentCode(true,function(){var item=sortedArray[sortChannelsMenu.getSelectedSourceItem()];item.is_parent_control=!item.is_parent_control;that.redrawAllMenus()});break}};this.key_left=function(){if(focusedMenu){focusedMenu.unsetMenuFocus()}switch(focusedMenu){default:case moveDownMenu:focusedMenu=parentMenu;break;case parentMenu:focusedMenu=hideMenu;break;case hideMenu:focusedMenu=moveUpMenu;break;case moveUpMenu:focusedMenu=moveDownMenu;break}if(focusedMenu){focusedMenu.setMenuFocus()}this.setHeadersAndLabels()};this.key_right=function(){if(focusedMenu){focusedMenu.unsetMenuFocus()}switch(focusedMenu){default:case moveDownMenu:focusedMenu=moveUpMenu;break;case moveUpMenu:focusedMenu=hideMenu;break;case hideMenu:focusedMenu=parentMenu;break;case parentMenu:focusedMenu=moveDownMenu;break}if(focusedMenu){focusedMenu.setMenuFocus()}this.setHeadersAndLabels()};this.key_down=function(){if(!Helper.stickyKeyPreventChecker(App.sortScreenUpDownStickyKeyPreventDelay)){return}this.setNextItemAllMenus()};this.key_up=function(){if(!Helper.stickyKeyPreventChecker(App.sortScreenUpDownStickyKeyPreventDelay)){return}this.setPreviousItemAllMenus()};this.key_ch_minus=this.key_left;this.key_ch_plus=this.key_right;this.key_yellow=function(){App.popupMenuScreen.addListMenuItem(App.lang.get("unlock-all-channels"),function(){App.popupMenuScreen.hide();that.callWithParentCode(true,function(){changed=true;for(var i=0;i<sortedArray.length;i++){sortedArray[i]["is_parent_control"]=false}that.setFirstItemAllMenus();that.redrawAllMenus()})});App.popupMenuScreen.addListMenuItem(App.lang.get("show-all-hidden-channels"),function(){var requestParentCode=false;for(var i=0;i<sortedArray.length;i++){if(sortedArray[i]["is_parent_control"]){requestParentCode=true;break}}App.popupMenuScreen.hide();that.callWithParentCode(requestParentCode,function(){changed=true;for(var i=0;i<sortedArray.length;i++){sortedArray[i]["is_hidden"]=false}that.setFirstItemAllMenus();that.redrawAllMenus()})});App.popupMenuScreen.addListMenuItem(App.lang.get("reset-sorting"),function(){App.popupMenuScreen.hide();that.callWithParentCode(false,function(){var channelParams={};for(var i in sortedArray){channelParams[sortedArray[i]["id"]]=sortedArray[i]}Helper.addClassForObject(selfScreenContainerObject,"loader");App.data.requestChannelList({account_sort:0,icon_width:40,icon_height:40},function(error,interval){Helper.removeClassForObject(selfScreenContainerObject,"loader");if(error==0){changed=true;var n=App.data.getNumberOfChannels(true);if(n>sortChannelsMenu.getNumberOfRows()){n=sortChannelsMenu.getNumberOfRows()}that.initSortedArray(channelParams);that.setFirstItemAllMenus();that.refreshAllMenus(n,App.data.getNumberOfChannels(true))}},false)})});App.popupMenuScreen.addListMenuItem(App.lang.get("reset-all"),function(){var requestParentCode=false;for(var i=0;i<sortedArray.length;i++){if(sortedArray[i]["is_parent_control"]){requestParentCode=true;break}}App.popupMenuScreen.hide();that.callWithParentCode(requestParentCode,function(){App.data.requestSettingsSaveChannelsSort("",function(){App.device.reload()})})});App.display.showPopupScreen("popup-menu")};this.key_menu=function(){if(changed&&sortedArray.length){return this.key_back()}else{App.display.showScreen("mainmenu")}};this.key_back=function(){if(changed&&sortedArray.length){App.popupMenuScreen.addListMenuItem(App.lang.get("save-sort-message"),function(){var list=JSON.stringify(sortedArray);App.data.requestSettingsSaveChannelsSort(list,function(){App.device.reload()})});App.popupMenuScreen.addListMenuItem(App.lang.get("return-to-sort-message"),function(){App.popupMenuScreen.hide()});App.popupMenuScreen.addListMenuItem(App.lang.get("not-save-sort-message"),function(){that.initSortedArray();that.redrawAllMenus();changed=false;App.popupMenuScreen.hide();that.setFirstItemAllMenus()});App.display.showPopupScreen("popup-menu")}else{App.display.showScreen("settings")}};this.key_exit=function(){if(changed&&sortedArray.length){return this.key_back()}else{if(App.player.isActive()){App.display.showScreen("player")}else{return this.key_back()}}};this.key_long_enter=function(){if(App.showHelpButtonPanelFlag){var keys=[{action:"yellow",label:"label-reset"},{action:"back",label:"label-back"}];App.popupKeyPanelScreen.setKeysForPanel(keys);App.popupKeyPanelScreen.setParentScreen("sort");App.display.showPopupScreen("popup-key-panel")}else{this.key_enter()}};this.wheel=function(delta){if(delta>0){this.key_down()}else{this.key_up()}}}var _SortScreen=new BaseScreen();SortScreen.prototype=_SortScreen;