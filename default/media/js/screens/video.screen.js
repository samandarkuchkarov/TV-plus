function VideoScreen(){var that=this;var videoActionsMenu=new BaseMenu({menuId:"videoactions-menu",menuTag:"ul",itemIdPrefix:"videoaction",itemTag:"li",useFastRefresh:true,hideItemIfEmptyName:true,getItemNameFunc:function(sourceItemIndex,displayItemIndex){if(videoActions&&videoActions.length>sourceItemIndex){return videoActions[sourceItemIndex]["caption"]}else{return""}},onItemClick:function(index){that.key_enter()},onItemMouseOver:function(index){var sourceItems=videoActionsMenu.getCurrentPage()*videoActionsMenu.getNumberOfDisplayItems()+index;videoActionsMenu.setSelectedItem(index,sourceItems)},getItemClassNameFunc:function(index){return"button"}});var videoActionsPanelObject=null;var video=null;var videoActions=[],videoAssets=[],isCurrentAssetSeries=false;var navigationMode="normal";var isVideoEnded=false;var playVideoFileAfterVideoIntro=false;var currencyStr="";this.show=function(){if(!videoActionsPanelObject){videoActionsPanelObject=Helper.byId("video-actions-panel")}if(!currencyStr){var currency=App.data.getCurrency();currencyStr=currency==="RUB"?App.lang.get("RUB"):currency}App.display.resetResized("video");App.playerScreen.hideTvInfoBar();App.playerScreen.hideVideoInfoBar();_VideoScreen.show()};this.init=function(){_VideoScreen.init();navigationMode=App.clientSettings.navigation_mode;if(navigationMode!=="horizontal"){Helper.hideById("videocatalog-footer-menu");Helper.showById("videocatalog-footer-left")}};this.resize=function(displayWidth,displayHeight){var fullVideoDescHeight=Helper.byId("full-video-description").offsetHeight;var videoDescHeight=Helper.byId("video-description").offsetHeight;if(App.settings.getStyleName()==="impuls_x"){var coverHeight=Helper.byId("video-cover").offsetHeight;var videoactionsPanelHeight=Helper.byId("video-actions-panel").offsetHeight+Helper.byId("video-actions-panel").style.marginTop;var videoDescMaxHeight=coverHeight-videoactionsPanelHeight-(fullVideoDescHeight-videoDescHeight);videoDescMaxHeight=videoDescMaxHeight-videoDescMaxHeight%Helper.lineHeight("video-description");Helper.byId("video-description").style.maxHeight=videoDescMaxHeight+"px"}else{var videoActionItemHeight=Helper.byId("video-actions-panel").offsetHeight+Helper.totalIndentVertical("video-actions-panel");var descriptionHeight=displayHeight-(fullVideoDescHeight-videoDescHeight)-videoActionItemHeight;descriptionHeight=descriptionHeight-descriptionHeight%Helper.lineHeight("video-description");Helper.byId("video-description").style.maxHeight=descriptionHeight+"px"}};this.isVideoEnd=function(){isVideoEnded=true};this.requestVideoActions=function(forcePlayVideo){if(!video){return}var that=this;videoActions=[];videoActionsMenu.clear();Helper.removeClassForObject(videoActionsPanelObject,"unavailable");Helper.addClassForObject(videoActionsPanelObject,"loader");App.data.requestVideoDetail({vid:video.id,external_api_request:1},function(error,videoDetail){if(error==0){videoActions=[];var val=videoDetail.actions.length;video.position=videoDetail.position;video.position_asset_id=videoDetail.position_asset_id;var forceVideoAction=null;for(var i=0;i<val;i++){var action=videoDetail.actions[i];if(action.action==="get_video_url"){videoActions[videoActions.length]={caption:videoDetail.is_season?App.lang.get("label-select-series"):App.lang.get("label-play"),file_id:action.file_id,duration:action.duration,price:-1,action:action.action,is_season:videoDetail.is_season};forceVideoAction=videoActions[videoActions.length-1];break}if(action.action!=="get_trailer_url"){var caption=action.caption;if(action.price&&action.price>0){caption+=" &ndash; "+Helper.toInt(action.price)+" "+currencyStr}videoActions[videoActions.length]={caption:caption,file_id:action.file_id,duration:action.duration,price:action.price,action:action.action,is_season:false}}}videoAssets=[];for(var i=0;i<val;i++){var assetAction=videoDetail.actions[i];if(assetAction.action==="get_video_url"){videoAssets[videoAssets.length]={caption:assetAction.caption,file_id:assetAction.file_id,duration:assetAction.duration,price:-1,action:assetAction.action,is_season:false}}}if(val===0){Helper.removeClassForObject(videoActionsPanelObject,"loader");Helper.addClassForObject(videoActionsPanelObject,"unavailable")}else{videoActionsMenu.clear();var n=3;if(videoActions.length<n){n=videoActions.length}videoActionsMenu.setNumberOfDisplayItems(n);videoActionsMenu.setNumberOfSourceItems(videoActions.length);videoActionsMenu.setSelectedItem(0,0);videoActionsMenu.redrawMenuItems();Helper.removeClassForObject(videoActionsPanelObject,"loader")}if(forcePlayVideo&&forceVideoAction){that.playVideoOrConfirmPurchase(forceVideoAction,true)}}})};this.setVideo=function(value){video=value;if(!video){return}Helper.setHtml("video-name",video.name);Helper.setHtml("origin-name",video.name_orig?video.name_orig:"");var minutes=video.duration;var hoursMin=(minutes-Math.floor(minutes/60)*60)+"";var hours=Math.floor(minutes/60)+":";if(hours.length===2){hours="0"+hours}if(hoursMin.length===1){hoursMin="0"+hoursMin}var str=minutes+" "+App.lang.get("min")+". / "+hours+hoursMin;Helper.setHtml("duration-time",str);Helper.setHtml("video-year",video.year?video.year+"<br />":"...");Helper.setHtml("video-director",video.director?video.director+"<br />":"...");Helper.setHtml("video-actors",video.actors?video.actors+"<br />":"...");Helper.setHtml("video-genre",video.genres?video.genres:"...");Helper.setHtml("video-description",video.description?Helper.cropString(video.description,550,"..."):"...");Helper.byId("video-cover").src=Helper.getResourceUrl(video.thumbnail_big);var rating=video.kinopoisk_rating!=="0.0"?"Кинопоиск "+video.kinopoisk_rating:"";rating+=video.imdb_rating!=="0.0"?(rating?" / ":"")+"IMDB "+video.imdb_rating:"";if(rating){Helper.setHtml("video-rating",rating);Helper.showById("video-rating")}else{Helper.hideById("video-rating")}var videoProvider=App.data.getVideoProviderTitle(video.provider);var videoProviderLogo=Helper.byId("video-provider-logo");if(videoProvider){Helper.setClassForObject(videoProviderLogo,"provider-logo-"+videoProvider.toLowerCase());Helper.showById("video-provided-by")}else{Helper.hideById("video-provided-by")}if(App.clientSettings.samsung_guidelines_compatibility_mode&&(App.device.getDeviceKind()==="tizen_tv"||App.device.getDeviceKind()==="lg_webos"||App.device.getDeviceKind()==="lg_netcast")){Helper.hideById("duration")}this.requestVideoActions()};this.getVideo=function(){return video};this.playVideoOrConfirmPurchase=function(videoAction,forcePlayVideo){var that=this;if(videoAction.price>=0&&!forcePlayVideo){App.popupMessageScreen.setMessageText(App.lang.get("purchase-confirmation-msg")+" "+Helper.toInt(videoAction.price)+" "+currencyStr+"?",App.popupMessageScreen.MODE_CHOICE);App.popupMessageScreen.setCallback(function(yes){if(yes){Helper.addClassForObject(videoActionsPanelObject,"loader");App.data.requestVideoAction({vid:video.id,action:videoAction.action},function(error){Helper.removeClassForObject(videoActionsPanelObject,"loader");switch(parseInt(error)){case 0:that.requestVideoActions(true);break;case 2:App.popupMessageScreen.setMessageText(App.lang.get("purchase-video-deficit-error-msg"),App.popupMessageScreen.MODE_CHOICE);App.popupMessageScreen.setCallback(function(yes){if(yes){App.balanceScreen.setPurchaseAmount(videoAction.price);App.balanceScreen.key_green()}});App.display.showPopupScreen("popup-message");that.requestVideoActions(false);break;case 3:App.popupMessageScreen.setMessageText(App.lang.get("purchase-video-duplication-error-msg"));App.display.showPopupScreen("popup-message");that.requestVideoActions(false);break;default:App.popupMessageScreen.setMessageText(App.lang.get("purchase-video-unknown-error-msg"));App.display.showPopupScreen("popup-message");that.requestVideoActions(false);break}})}});App.display.showPopupScreen("popup-message")}else{isCurrentAssetSeries=videoAction.is_season;if(videoAction.is_season||videoAssets.length>1){var vl=videoAssets.length;for(var i=0;i<vl;i++){App.popupMenuScreen.addListMenuItem(videoAssets[i]["caption"],function(index){var seriesAction=videoAssets[index];var videoFile=App.data.createVideoFile({id:seriesAction.file_id,name:seriesAction.caption,duration:seriesAction.duration*60});that.playVideoFile(videoFile);App.popupMenuScreen.hide()})}var index=video.position_asset_id-videoAssets[0]["file_id"];if(video.position_asset_id!==-1&&index>0&&isCurrentAssetSeries){App.popupMenuScreen.setListMenuSelectedItem(index)}App.display.showPopupScreen("popup-menu")}else{var videoFile=App.data.createVideoFile({id:videoAction.file_id,name:video.name,duration:videoAction.duration*60});that.playVideoFile(videoFile)}}};this.videoOnStopCallback=function(){if(playVideoFileAfterVideoIntro){this.playVideoFile(playVideoFileAfterVideoIntro,true)}else{App.videoScreen.setVideo(App.playerScreen.getVideo());try{if(isCurrentAssetSeries){var index=parseInt(App.player.getPlayingItemId())-parseInt(videoAssets[0]["file_id"]);if(videoAssets.length>0&&index+1<videoAssets.length&&isVideoEnded){isVideoEnded=false;var seriesAction=videoAssets[index+1];var videoFile=App.data.createVideoFile({id:seriesAction.file_id,name:seriesAction.caption,duration:seriesAction.duration*60});video.series_name=videoFile.name;App.playerScreen.setVideo(video);App.playerScreen.setVideoFile(videoFile);App.player.setPlayingItemId(videoFile.id);App.player.setPlayingItemName(video.name);App.player.setStreamUrl(videoFile.url);App.player.setBeginTime(0);App.player.setEndTime(parseInt(videoFile.duration));App.player.setCurrentTime(0);App.player.play()}else{App.display.showScreen("video")}}else{App.display.showScreen("video")}}catch(e){App.display.showScreen("video")}}};this.playVideoFile=function(videoFile,skipProviderIntro){if(!video){return}video.series_name=videoFile.name;App.playerScreen.setRefreshInfoCallback(null);App.playerScreen.setVideo(video);App.playerScreen.setVideoFile(videoFile);App.player.setOnStopCallback(null);App.player.stop();App.player.setMode(App.player.MODE_VIDEO);playVideoFileAfterVideoIntro=false;if(!skipProviderIntro){var introUrl=App.data.getVideoProviderIntro(video.provider);if(introUrl){App.player.setStreamUrl(introUrl);App.player.setBeginTime(0);App.player.setEndTime(0);App.player.setCurrentTime(0);playVideoFileAfterVideoIntro=videoFile;App.player.play();App.display.showScreen("player");return}}App.player.setChannel(null);App.player.setProgram(null);App.player.setVideo(video);App.player.setPlayingItemId(videoFile.id);App.player.setPlayingItemName(video.name);App.player.setStreamUrl(videoFile.url);App.player.setBeginTime(0);App.player.setEndTime(parseInt(videoFile.duration));App.player.setCurrentTime(0);App.player.setOnStopCallback(function(){App.videoScreen.videoOnStopCallback()});App.display.showScreen("player");if(video.position>0&&video.position_asset_id==videoFile.id){App.player.setOnStreamInfoReadyCallback(function(){var position=App.videoScreen.getVideo()["position"];var duration=Helper.toInt(App.player.getEndTime())*60;var remainingTime=duration-position;if(remainingTime<0){remainingTime=0}if(remainingTime>0&&position<duration*0.99){var s=App.lang.get("video-resume-from-position-msg")+" "+Helper.formatSeconds(position,true)+", "+App.lang.get("video-remaining-time-msg")+" "+Helper.formatSeconds(remainingTime,true)+".<br><br>"+App.lang.get("press-ok-to-resume-video-msg");App.popupMessageScreen.setMessageText(s,App.popupMessageScreen.MODE_CHOICE);App.popupMessageScreen.setCallback(function(yes){if(yes){App.player.resume();App.player.rewind(position,true)}App.player.resume()});App.player.pause();App.display.showPopupScreen("popup-message")}})}App.player.play()};this.key_back=function(){App.display.showScreen("videocatalog")};this.key_right=function(){videoActionsMenu.setNextItem()};this.key_left=function(){if(navigationMode==="horizontal"){App.display.showScreen("videocatalog")}else{videoActionsMenu.setPreviousItem()}};this.key_enter=function(){if(!video){return}if(videoActions.length<=0){return}var videoAction=videoActions[videoActionsMenu.getSelectedSourceItem()];this.playVideoOrConfirmPurchase(videoAction,false)};this.key_menu=function(){App.display.showScreen("mainmenu")};this.key_exit=function(){if(App.player.isActive()){App.display.showScreen("player")}else{App.display.showScreen("videocatalog")}};this.key_backspace=function(){this.key_exit()};this.key_power=function(){App.switchStandBy()};this.wheel=function(){return true};this.key_long_enter=function(){if(App.showHelpButtonPanelFlag){var keys=[{action:"back",label:"label-back"}];App.popupKeyPanelScreen.setKeysForPanel(keys);App.popupKeyPanelScreen.setParentScreen("video");App.display.showPopupScreen("popup-key-panel")}else{this.key_enter()}}}_VideoScreen=new BaseScreen();VideoScreen.prototype=_VideoScreen;