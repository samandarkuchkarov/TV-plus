var maps=[];maps[0]=mapConst;maps[1]=mapConst2;maps[2]=mapConst3;maps[3]=mapConst4;maps[4]=mapConst5;maps[5]=mapConst6;maps[6]=mapConst7;maps[7]=mapConst8;maps[8]=mapConst9;maps[9]=mapConst10;maps[10]=mapConst11;maps[11]=mapConst12;maps[12]=mapConst13;maps[13]=mapConst14;maps[14]=mapConst15;maps[15]=mapConst16;maps[16]=mapConst17;maps[17]=mapConst18;maps[18]=mapConst19;maps[19]=mapConst20;function PrintNumbers(val,xN,yN,arr){var tem=val,temAr=[];while(tem>0){temAr.push(tem%10);tem=(tem-tem%10)/10}if(temAr.length==0){temAr[0]=0}var xS=xN;for(var i=temAr.length-1;i>=0;i--){ctx2.drawImage(arr[temAr[i]],xS,yN);xS+=24}}function ClearNumbers(val,xN,yN){var tem=val,temAr=[];while(tem>0){temAr.push(tem%10);tem=(tem-tem%10)/10}if(temAr.length==0){temAr[0]=0}var xS=xN;ctx2.fillStyle="#808080";for(var i=temAr.length-1;i>=0;i--){ctx2.fillRect(xS,yN,24,24);xS+=24}ctx2.fillStyle="#000000"}function RegisterResourses(address,resourse,load_callback){resourse.src=address;resourse_counter++;resourse.onload=function(){resourse_counter--;if(resourse_counter<=0){load_callback()}}}function initMenu(){canvas=document.getElementById("canvas");canvas0=document.getElementById("canvas0");canvas1=document.getElementById("canvas1");canvas2=document.getElementById("canvas2");canvas3=document.getElementById("canvas3");canvas4=document.getElementById("canvas4");canvasOffsetLeft=canvas.offsetLeft;canvasOffsetTop=canvas.offsetTop;canvas.width=692;canvas.height=492;ctx=canvas.getContext("2d");ctx0=canvas0.getContext("2d");ctx1=canvas1.getContext("2d");ctx2=canvas2.getContext("2d");ctx3=canvas3.getContext("2d");ctx4=canvas4.getContext("2d");arrayOfCanvases[0]=ctx;arrayOfCanvases[1]=ctx1;arrayOfCanvases[2]=ctx2;arrayOfCanvases[3]=ctx3;arrayOfCanvases[4]=ctx4;arrayOfCanvases[5]=ctx0;menu=new Image();tanks[1]=new Image();curI=0;curY=cursor[curI];curX=200;RegisterResourses("media/js/games/battle_city/images/menu-bg.png",menu,function(){choiceMode()});RegisterResourses("media/js/games/battle_city/images/hero-up.png",tanks[1],function(){choiceMode()})}function choiceMode(){ctx.drawImage(menu,0,0);ctx.drawImage(tanks[1],curX,curY);windCount=0}function initAfterFolding(){ctx.fillStyle="#000000";ctx.fillRect(0,0,492,canvas.height);ctx.fillStyle="#808080";ctx.fillRect(492,0,100,canvas.height);ctx.fillStyle="#000000";image(2)}function initBattleCity(){for(var e=0;e<4;e++){scoreArray[e]=0}yG=38*cell;win=-1;enemiesCount=20;for(var i=0;i<maps[numberOfStage].length;i++){map[i]=[].concat(maps[numberOfStage][i])}for(i=0;i<maps[numberOfStage].length;i++){mapForBonus[i]=[].concat(maps[numberOfStage][i])}paused=false;timeCount=0;bonusTime=0;wallTime=-1;helmetTime=0;tankCount=21;game_over=-1;if(numberOfStage==0){for(i=0;i<5;i++){enemies[i]=new Bot()}}else{for(i=1;i<5;i++){enemies[i]=new Bot()}}ctx.fillStyle="#000000";ctx.fillRect(0,0,492,canvas.height);ctx.fillStyle="#808080";ctx.fillRect(492,0,100,canvas.height);ctx.fillStyle="#000000";image(0)}function PrintScoreTable(isWin){ctx2.drawImage(ScoreTable,0,0);PrintNumbers(scoreArray[0],480,80,ns);PrintNumbers(scoreArray[1],480,150,ns);PrintNumbers(scoreArray[2],480,220,ns);PrintNumbers(scoreArray[3],480,290,ns);PrintNumbers(points,420,370,ns);game_over++;if(isWin==0){pointsForRecord=points}else{App.data.requestGameScoreSave({game:"battle_city",score:pointsForRecord},function(error){})}}function drawStageNumbers(){var num=numberOfStage+1;ctx.drawImage(stage,240,238);if(num>=10){ctx.drawImage(nums[Math.ceil(num/10)],385,238);ctx.drawImage(nums[Math.ceil(num%10)],405,238)}else{ctx.drawImage(nums[num],385,238)}}function timerLaunch(){timer=setInterval(function(){timeCount+=timerInterval;if(bonusTime!=0){bonusTime-=timerInterval}if(wallTime>0){wallTime-=timerInterval}if(wallTime==0){ChangeStaffWall(1);wallTime=-1}if(helmetTime>0&&game_over<55){helmetTime-=timerInterval;if(enemies[0].getTickForBirth()<0){ctx1.clearRect(enemies[0].getX(),enemies[0].getY(),tankWid,tankWid);imgFrame=frames[(countFrames++)%2];oldX=enemies[0].getX();oldY=enemies[0].getY();ctx1.drawImage(imgFrame,oldX,oldY)}if(helmetTime==0){ctx1.clearRect(enemies[0].getX(),enemies[0].getY(),tankWid,tankWid);enemies[0].setIdinMap(6);enemies[0].addOnMap()}}if(queueOfAnimations.length!=0){for(var q=0;q<queueOfAnimations.length;q++){arrayOfCanvases[queueOfAnimations[q][0]].drawImage(queueOfAnimations[q][1][queueOfAnimations[q][2]],queueOfAnimations[q][3],queueOfAnimations[q][4]);queueOfAnimations[q][5]--;if(queueOfAnimations[q][5]==0){arrayOfCanvases[queueOfAnimations[q][0]].clearRect(queueOfAnimations[q][3],queueOfAnimations[q][4],queueOfAnimations[q][6],queueOfAnimations[q][7]);queueOfAnimations.splice(q,1)}else{queueOfAnimations[q][2]++}}}if(enemies[0].getTickForBirth()>=0){if(enemies[0].getTickForBirth()==11&&!(isTankNoSituated(tx,ty))){}else{enemies[0].birthHero(tx,ty,0)}}if(bonusTime==0&&enemies.length<5&&tankCount>0&&(isTankNoSituated(cell,y)||isTankNoSituated(cell*37,y))&&(timeCount-timeOfLastDeath)>=intervalForRevival){enemies[enemies.length]=new Bot();if(isTankNoSituated(cell,y)){enemies[enemies.length-1].init(etanks,cell,y,1);x[enemies.length-1]=cell}else{enemies[enemies.length-1].init(etanks,cell*37,y,1);x[enemies.length-1]=cell*37}tankCount--}if(bonObj!=null){if(isTankOnBonus(enemies[0].getX(),enemies[0].getY(),bonObj.letterInMap)){enemies[0].ActivateBonus(bonObj.letterInMap);bonObj.deathOfBonus();delete bonObj}}for(var g=1;g<enemies.length;g++){if(timeCount%(1000*g)==0&&isTankNoSituated(enemies[g].getX(),enemies[g].getY())&&enemies[g].getTickForBirth()==11&&game_over<0){enemies[g].isGenerate=true}if(enemies[g].getTickForBirth()>=0&&enemies[g].isGenerate&&!enemies[g].getKilled()){enemies[g].birthHero(enemies[g].getX(),enemies[g].getY(),g)}}for(var k=0;k<bullets.length;k++){if(!bullets[k].isFlight){delete bullets[k];bullets.splice(k,1);k--}}for(var i=1;i<enemies.length;i++){if(enemies[i].getTickForBirth()<0&&bonusTime==0){setPosition(img,i)}if(game_over==-1){forShoot=(Math.floor(Math.random()*37)+1)%chanceForShoot;if(win!=1&&bonusTime==0&&forShoot==1&&enemies[i].getTickForBirth()<0&&(timeCount-enemies[i].gettimeOfLastBullet())>intervalForBullet){birthBull(i);enemies[i].settimeOfLastBullet(timeCount)}}}for(k=0;k<bullets.length;k++){for(var s=0;s<bullets[k].speed;s++){bullets[k].moveB()}}for(i=0;i<enemies.length;i++){if(enemies[i].getKilled()){delete enemies[i];enemies.splice(i,1);i--;timeOfLastDeath=timeCount;ClearNumbers(enemiesCount,538,67);enemiesCount--;PrintNumbers(enemiesCount,538,67,nums)}}if(enemies.length==1&&tankCount==0&&win!=1){win=0;for(i=0;i<map.length;i++){for(var j=0;j<map[i].length;j++){if(map[i][j]==3||map[i][j]==4){map[i][j]=7}}}switch(game_over){case 55:for(q=0;q<arrayOfCanvases.length;q++){arrayOfCanvases[q].clearRect(0,0,canvas.width,canvas.height)}if(numberOfStage==maps.length-1){numberOfStage=0;points=0}else{numberOfStage++}helmetTime=0;PrintScoreTable(0);break;case 120:clearInterval(timer);ctx.fillStyle="#808080";ctx.fillRect(0,0,canvas.width,canvas.height);ctx2.clearRect(0,0,canvas2.width,canvas2.height);drawStageNumbers();windCount=4;break;default:game_over++;break}}},timerInterval)}function timerStop(){if(timer!=null){clearTimeout(timer)}if(timerBots!=null){clearTimeout(timerBots)}}function renderingMap(){for(var i=0;i<n;i++){for(var j=0;j<m;j++){switch(true){case (map[i][j]==1):ctx.drawImage(img11,i*cell,j*cell);break;case (map[i][j]==3):ctx.drawImage(eagle,i*cell,j*cell);break;case (map[i][j]==5):ctx.drawImage(stone,i*cell,j*cell);break;case (map[i][j]==7):if(i!=0&&j!=0&&i!=40&&j!=40){break}else{ctx.drawImage(border,i*cell,j*cell)}break;case (map[i][j]=="s"):ctx.drawImage(sea,i*cell,j*cell);break;case (map[i][j]=="f"):ctx2.drawImage(forest,i*cell,j*cell);break;case (map[i][j]=="b"||map[i][j]=="h"||map[i][j]=="l"||map[i][j]=="w"||map[i][j]=="m"||map[i][j]=="t"):ctx1.drawImage(bonImages[bonObj.getNumberOfBonus()],i*cell,j*cell);break}}}ctx.drawImage(etanks[1],500,60);ctx.drawImage(heart,500,110);ctx.drawImage(level,500,150);PrintNumbers(numberOfStage+1,535,155,nums);PrintNumbers(enemiesCount,538,67,nums)}function move(){renderingMap();var tempLifes=3,tempType="simple",tempArray=[].concat(tanks),tempStars=0;if(numberOfStage>0){tempLifes=enemies[0].getLifes();tempType=enemies[0].typeB;tempArray=[].concat(enemies[0].getArrayOfImages());tempStars=enemies[0].getStars()}enemies[0].init(tanks,tx,ty,0);enemies[0].setLifes(tempLifes);enemies[0].typeB=tempType;enemies[0].setArrayOfImages(tempArray);enemies[0].setStars(tempStars);PrintNumbers(enemies[0].getLifes(),538,115,nums);tankCount--;for(var i=1;i<enemies.length;i++){x[i]=(Math.floor(Math.random()*37)+1)*cell;while(!(isTankNoSituated(x[i],y))){x[i]=(Math.floor(Math.random()*37)+1)*cell}}for(i=1;i<enemies.length;i++){enemies[i].init(etanks,x[i],y,1);tankCount--}timerLaunch()}function moveAfterFolding(){ctx4.drawImage(pause,200,238);renderingMap();PrintNumbers(enemies[0].getLifes(),538,115,nums);for(var i=0;i<enemies.length;i++){if(enemies[i].getTickForBirth()<=0){ctx.drawImage(enemies[i].getImg(),enemies[i].getX(),enemies[i].getY())}}}function setPosition(Bot,_i){if(game_over>0){win=1;var xG=16*cell;switch(true){case (game_over==1):game_over++;ctx.clearRect(19*cell,37*cell,tankWid,tankWid);ctx.drawImage(crashEagle,19*cell,37*cell);ctx4.drawImage(gameOver,xG,yG);break;case ((game_over>=50&&game_over<=54)||(game_over>55&&game_over<150)):game_over++;break;case (game_over==55):for(var q=0;q<arrayOfCanvases.length;q++){arrayOfCanvases[q].clearRect(0,0,canvas.width,canvas.height)}PrintScoreTable(1);break;case (game_over==150):clearInterval(timer);numberOfStage=0;points=0;ctx2.clearRect(0,0,canvas2.width,canvas2.height);ctx.drawImage(g_o,0,0);enemies.length=0;bullets.length=0;map.length=0;mapForBonus.length=0;windCount=3;break;default:game_over++;ctx4.clearRect(xG,yG,103,48);yG-=5;ctx4.drawImage(gameOver,xG,yG);break}}else{if(!enemies[_i].getKilled()){enemies[_i].emove(_i);if(enemies[_i].typeB=="eimprove1"||enemies[_i].typeB=="eimprove1bonus"){enemies[_i].emove(_i)}}}}function ChangeStaffWall(ind){if(ind==1){for(var w=0;w<staffWall[0].length;w++){ctx.drawImage(img11,staffWall[0][w]*cell,staffWall[1][w]*cell);map[staffWall[0][w]][staffWall[1][w]]=1}}else{for(w=0;w<staffWall[0].length;w++){ctx.drawImage(stone,staffWall[0][w]*cell,staffWall[1][w]*cell);map[staffWall[0][w]][staffWall[1][w]]=5;if(map[staffWall[0][w]][staffWall[1][w]]>1){for(var m=0;m<enemies.length;m++){for(var n=0;n<3;n++){if(map[staffWall[0][w]][staffWall[1][w]]==enemies[m].getIdInMap()){ChoiseTankForDeath(m);queueOfAnimations[queueOfAnimations.length]=[3,crashBullets,3,enemies[m].getX()-tankWid/2,enemies[m].getY()-tankWid/2,2,tankWid*2,tankWid*2];scoreArray[3]++;break}}}}}}}function moveFrames(_x,_y,dir){var dx=[-1,0,1,0],dy=[0,-1,0,1],tmpX=_x+tankStep*dx[dir],tmpY=_y+tankStep*dy[dir];ctx1.clearRect(_x,_y,tankWid,tankWid);ctx1.drawImage(imgFrame,tmpX,tmpY);oldX=tmpX;oldY=tmpY}function isTankNoSituated(_x,_y){var tmpX=_x/cell,tmpY=_y/cell,res=false,dx=[0,1,1,0,2,2,0,1,2],dy=[0,1,0,1,2,0,2,2,1];for(var i=0;i<dx.length;i++){res=res||mapForBonus[tmpX+dx[i]][tmpY+dy[i]]!=0}return !res}function isTankOnBonus(_x,_y,val){var tmpX=_x/cell,tmpY=_y/cell,res=false,dx=[0,0,0,1,2,2,2,1],dy=[0,1,2,0,0,1,2,2];for(var i=0;i<dx.length;i++){res=res||mapForBonus[tmpX+dx[i]][tmpY+dy[i]]==val}return res}function birthBull(_i){b=new Bullet();d=enemies[_i].getDirection();b.con(d,enemies[_i].getX()+shiftBulletX[d],enemies[_i].getY()+shiftBulletY[d],_i);if(enemies[_i].typeB=="improve1"||enemies[_i].typeB=="eimprove2"){b.speed=5}if(enemies[_i].typeB=="improve3"){b.power=1}bullets.push(b)}function isBulWayFree(_x,_y,dir,list){var tmpX=Math.floor(_x/cell),tmpY=Math.floor(_y/cell),res=(_x!=480&&_y!=480&&_x!=0&&_y!=0),tmp;for(var i=0;i<dcx1[0].length;i++){tmp=false;for(var j=0;j<list.length;j++){tmp=tmp||map[tmpX+dcx1[dir][i]][tmpY+dcy1[dir][i]]==list[j]}res=res&&tmp}return res}function isBulWayBarrier(_x,_y,dir,val){var tmpX=Math.floor(_x/cell),tmpY=Math.floor(_y/cell);return map[tmpX+dcx1[dir][0]][tmpY+dcy1[dir][0]]==val||map[tmpX+dcx1[dir][1]][tmpY+dcy1[dir][1]]==val||map[tmpX+dcx1[dir][2]][tmpY+dcy1[dir][2]]==val}function isBulWayEnemy(_x,_y,dir,val){var tmpX=Math.floor(_x/cell),tmpY=Math.floor(_y/cell);return map[tmpX+dcx1[dir][0]][tmpY+dcy1[dir][0]]>val||map[tmpX+dcx1[dir][1]][tmpY+dcy1[dir][1]]>val||map[tmpX+dcx1[dir][2]][tmpY+dcy1[dir][2]]>val}function CrashWall(_x,_y,dir,val){for(var n=0;n<dcx1[0].length;n++){if(map[Math.floor(_x/cell+dcx1[dir][n])][Math.floor(_y/cell+dcy1[dir][n])]==val){ctx.fillRect(Math.floor(_x+dcx1[dir][n]*cell),Math.floor(_y+dcy1[dir][n]*cell),cell,cell);map[Math.floor(_x/cell+dcx1[dir][n])][Math.floor(_y/cell+dcy1[dir][n])]=0}}}function ActionForDeathTank(_points,pointsNumber,tank,isAfterBonus,isBonusTank){if(!isAfterBonus){queueOfAnimations[queueOfAnimations.length]=[3,pointsNums,pointsNumber,tank.getX()-tankWid/2-24,tank.getY()-tankWid/2+24,3,24,cell];points+=_points}if(isBonusTank){bonObj=new Bonus();bonObj.birthBonus(tank.getIdInMap());ctx1.clearRect(tank.getX(),tank.getY(),tankWid,tankWid)}if(_points!=0){scoreArray[_points/100-1]++}}function HardEnemyTransformation(tank){tank.setArrayOfImages(eimproves333[tank.getLifes()-1]);tank.setImg(eimproves333[tank.getLifes()-1][tank.getDirection()]);ctx.fillRect(tank.getX(),tank.getY(),tankWid,tankWid);ctx.drawImage(tank.getImg(),tank.getX(),tank.getY())}function ChoiseTankForDeath(m,isAfterBonus){var tank=enemies[m],tankX=tank.getX(),tankY=tank.getY();switch(tank.typeB){case"simplebonus":ActionForDeathTank(100,0,tank,isAfterBonus,true);break;case"eimprove1bonus":ActionForDeathTank(200,3,tank,isAfterBonus,true);break;case"eimprove2bonus":ActionForDeathTank(300,6,tank,isAfterBonus,true);break;case"eimprove3bonus":ActionForDeathTank(0,0,tank,true,true);HardEnemyTransformation(tank);tank.typeB="eimprove3";break;case"eimprove3":if(tank.getLifes()==1){ActionForDeathTank(400,9,tank,isAfterBonus,false);tank.clearMap();ctx.fillRect(tankX,tankY,tankWid,tankWid)}else{HardEnemyTransformation(tank)}break;case"eimprove2":ActionForDeathTank(300,6,tank,isAfterBonus,false);break;case"eimprove1":ActionForDeathTank(200,3,tank,isAfterBonus,false);break;default:if(m!=0){ActionForDeathTank(100,0,tank,isAfterBonus,false)}}if(tank.typeB!="eimprove3"&&tank.typeB!="eimprove3bonus"){tank.clearMap();ctx.fillRect(tankX,tankY,tankWid,tankWid)}tank.decLifes();if(tank.getLifes()==0){tank.setKilled(true)}}function DeathOfTank(_x,_y,dir){for(var m=0;m<enemies.length;m++){for(var n=0;n<3;n++){if(map[Math.floor(_x/12+dcx1[dir][n])][Math.floor(_y/12+dcy1[dir][n])]==enemies[m].getIdInMap()){ChoiseTankForDeath(m,false);queueOfAnimations[queueOfAnimations.length]=[3,crashBullets,3,enemies[m].getX()-tankWid/2,enemies[m].getY()-tankWid/2,2,tankWid*2,tankWid*2];break}}}};